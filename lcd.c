#include "STC32G.H"
#include "lcd.h"
#include <intrins.h>
#include "config.h"
#include "relay.h"

// 在文件顶部添加：
unsigned char zeroFont[16] = {0};
unsigned char numstr[] = "0123456789";


// 延时函数
void LCD_Delay(unsigned int count)
{
    unsigned int i, j;
    for(i=0; i<count; i++)
        for(j=0; j<120; j++);
}

// SPI方式发送一个字节
void LCD_WriteByte(unsigned char dat)
{
    unsigned char i;
    LCD_CS = 0;            // 片选有效
    delay_us(5);
		LCD_SCLK = 1;
    for(i = 0; i < 8; i++)
    {
        LCD_SCLK = 0;          // 时钟低电平
        delay_us(2);
        if(dat & 0x80)          // 发送最高位
            LCD_SDA = 1;
        else
            LCD_SDA = 0;
        delay_us(5);     
			
        LCD_SCLK = 1;           // 时钟高电平
        delay_us(5);
				
				LCD_SCLK = 0;      // 下降沿（准备下一比特）
        delay_us(2);    // 时钟低电平保持时间
				
        dat <<= 1;              // 左移一位
    }
    delay_us(2);
    LCD_SCLK = 1;              // 结束时保持时钟低电平
    LCD_CS = 1;                // 片选无效
	delay_us(10);       // 片选无效时间
}

// 写命令到LCD（更严格的控制）
void LCD_WriteCommand(unsigned char command)
{
    LCD_RS = 0;            // RS=0选择命令
    delay_us(2);        // 等待RS稳定   
    
    LCD_WriteByte(command);// 发送命令
    
    delay_us(2);        // 等待命令完成
}

// 写数据到LCD（更严格的控制）
void LCD_WriteData(unsigned char dat)
{
    LCD_RS = 1;            // RS=1选择数据
    delay_us(2);        // 等待RS稳定
    
    LCD_WriteByte(dat);    // 发送数据
    
    delay_us(2);        // 等待数据完成
}
// 设置LCD地址（页和列）
void LCD_SetAddress(unsigned char page, unsigned char column)
{
    // 设置页地址 (0-7)
    LCD_WriteCommand((unsigned char)(LCD_PAGE_ADDR + (page & 0x07)));
    
    // 设置列地址（分高4位和低4位）
    LCD_WriteCommand((unsigned char)(LCD_COL_ADDR_H + ((column >> 4) & 0x0F)));  // 高4位
    LCD_WriteCommand((unsigned char)(LCD_COL_ADDR_L + (column & 0x0F)));         // 低4位
}

// 打开背光
void LCD_BacklightOn(void)
{
    LCD_BL = 1;  // 低电平导通三极管，打开背光
}
// 关闭背光
void LCD_BacklightOff(void)
{
    LCD_BL = 0;  // 低高电平关断三极管，关闭背光
}

// LCD初始化
void LCD_Init(void)
{
    // 先关闭背光
    LCD_BL = 0;
    
    // 初始化引脚状态
    LCD_CS = 1;     // CS空闲时为高电平
    LCD_SCLK = 1;   // 时钟空闲时为低电平
    LCD_SDA = 0;    // 数据线初始为0
    LCD_RS = 1;     // 命令模式
    LCD_RST = 1;    // 复位先拉高
    LCD_Delay(10);  // 等待稳定
    
    // 硬件复位
    LCD_RST = 0;    // 复位有效（低）
    LCD_Delay(200); // 保持复位状态200ms
    LCD_RST = 1;    // 复位无效（高）
    LCD_Delay(200); // 等待复位完成

    // 软件初始化序列
    LCD_WriteCommand(0xE2);  // 软复位
    LCD_Delay(10);
 
    LCD_WriteCommand(0xA2);  // 设置偏压比 1/9
    LCD_WriteCommand(0xA0);  // ADC正常方向（从左到右）
    LCD_WriteCommand(0xC8);  // 扫描方向：从下到上
    
    LCD_WriteCommand(0x2C);  // 升压步骤1
    LCD_Delay(5);
    LCD_WriteCommand(0x2E);  // 升压步骤2
    LCD_Delay(5);
    LCD_WriteCommand(0x2F);  // 升压步骤3
    LCD_Delay(10);
    
    LCD_WriteCommand(0x24);  // 设置内部电阻比例
    LCD_WriteCommand(0x81);  // 设置电子体积模式
    LCD_WriteCommand(0x0C);  // 设置对比度为中等值
    
    LCD_WriteCommand(0x40);  // 设置显示起始行为第一行
    //LCD_WriteCommand(0xB0);  // 设置页地址为0
    //LCD_WriteCommand(0x10);  // 设置列地址高4位为0
    //LCD_WriteCommand(0x00);  // 设置列地址低4位为0
    
    LCD_WriteCommand(0xAF);  // 开显示
    LCD_Delay(100);
		
    // 清屏
    LCD_Clear();
    LCD_Delay(50);
		//打开背光
		LCD_BacklightOn();
		LCD_Delay(50);
}
// 清屏函数
void LCD_Clear(void)
{
    unsigned char page, col;
    
    // 先设置显示起始行
    LCD_WriteCommand(0x40);  // 设置显示起始行为0
    
    // 清除所有页
    for(page = 0; page < LCD_PAGES; page++)
    {
        // 设置页地址
        LCD_WriteCommand(0xB0 | page);
        // 设置列地址为0
        LCD_WriteCommand(0x10);  // 列地址高4位
        LCD_WriteCommand(0x00);  // 列地址低4位
        
        // 清除该页所有列
        for(col = 0; col < LCD_WIDTH; col++)
        {
            LCD_WriteData(0x00);
        }
    }
}

// 清除指定页范围的函数
void LCD_ClearPages(unsigned char start_page, unsigned char end_page)
{
    unsigned char page, col;
    
    // 检查页范围是否有效
    if(start_page > end_page || end_page >= LCD_PAGES)
    {
        return;  // 无效范围，直接返回
    }
    
    // 先设置显示起始行
    LCD_WriteCommand(0x40);  // 设置显示起始行为0
    
    // 清除指定范围的页
    for(page = start_page; page <= end_page; page++)
    {
        // 设置页地址
        LCD_WriteCommand(0xB0 | page);
        // 设置列地址为0
        LCD_WriteCommand(0x10);  // 列地址高4位
        LCD_WriteCommand(0x00);  // 列地址低4位
        
        // 清除该页所有列
        for(col = 0; col < LCD_WIDTH; col++)
        {
            LCD_WriteData(0x00);
        }
    }
}

// 8x12字符字模（ASCII字符：数字、大写字母、小写字母）
unsigned char code ASCII_8x16[][16] = {
    // 空格 (0x20)
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    // 数字 0-9 (0x30-0x39)
    {0x00,0x07,0x08,0x10,0x10,0x08,0x07,0x00,0x00,0xF0,0x08,0x04,0x04,0x08,0xF0,0x00}, // 0
    {0x00,0x08,0x08,0x1F,0x00,0x00,0x00,0x00,0x00,0x04,0x04,0xFC,0x04,0x04,0x00,0x00}, // 1
    {0x00,0x0E,0x10,0x10,0x10,0x11,0x0E,0x00,0x00,0x0C,0x14,0x24,0x44,0x84,0x0C,0x00}, // 2
    {0x00,0x0C,0x10,0x11,0x11,0x12,0x0C,0x00,0x00,0x18,0x04,0x04,0x04,0x88,0x70,0x00}, // 3
    {0x00,0x00,0x03,0x04,0x08,0x1F,0x00,0x00,0x00,0xE0,0x20,0x24,0x24,0xFC,0x24,0x00}, // 4
    {0x00,0x1F,0x11,0x11,0x11,0x10,0x10,0x00,0x00,0x98,0x04,0x04,0x04,0x88,0x70,0x00}, // 5
    {0x00,0x07,0x08,0x11,0x11,0x18,0x00,0x00,0x00,0xF0,0x88,0x04,0x04,0x88,0x70,0x00}, // 6
    {0x00,0x1C,0x10,0x10,0x13,0x1C,0x10,0x00,0x00,0x00,0x00,0xFC,0x00,0x00,0x00,0x00}, // 7
    {0x00,0x0E,0x11,0x10,0x10,0x11,0x0E,0x00,0x00,0x38,0x44,0x84,0x84,0x44,0x38,0x00}, // 8
    {0x00,0x07,0x08,0x10,0x10,0x08,0x07,0x00,0x00,0x00,0x8C,0x44,0x44,0x88,0xF0,0x00}, // 9
    // 大写字母 A-Z (0x41-0x5A)
    {0x00,0x01,0x06,0x18,0x06,0x01,0x00,0x00,0x00,0xFC,0x20,0x20,0x20,0xFC,0x00,0x00}, // A
    {0x00,0x1F,0x11,0x11,0x11,0x0E,0x00,0x00,0x00,0xFC,0x04,0x04,0x04,0xF8,0x00,0x00}, // B
    {0x00,0x0F,0x10,0x10,0x10,0x08,0x00,0x00,0x00,0xF0,0x08,0x04,0x04,0x08,0x00,0x00}, // C
    {0x00,0x1F,0x10,0x10,0x10,0x0F,0x00,0x00,0x00,0xFC,0x04,0x04,0x04,0xF8,0x00,0x00}, // D
    {0x00,0x1F,0x11,0x11,0x11,0x10,0x00,0x00,0x00,0xFC,0x04,0x04,0x04,0x04,0x00,0x00}, // E
    {0x00,0x1F,0x11,0x11,0x11,0x10,0x00,0x00,0x00,0xFC,0x00,0x00,0x00,0x00,0x00,0x00}, // F
    {0x00,0x0F,0x10,0x10,0x10,0x08,0x00,0x00,0x00,0xF0,0x08,0x04,0x44,0x78,0x00,0x00}, // G
    {0x00,0x1F,0x01,0x01,0x01,0x1F,0x00,0x00,0x00,0xFC,0x00,0x00,0x00,0xFC,0x00,0x00}, // H
    {0x00,0x10,0x10,0x1F,0x10,0x10,0x00,0x00,0x00,0x04,0x04,0xFC,0x04,0x04,0x00,0x00}, // I
    {0x00,0x00,0x10,0x10,0x1F,0x10,0x00,0x00,0x00,0x18,0x04,0x04,0xF8,0x00,0x00,0x00}, // J
    {0x00,0x1F,0x01,0x01,0x01,0x1E,0x00,0x00,0x00,0xFC,0x00,0xC0,0x30,0x0C,0x00,0x00}, // K
    {0x00,0x1F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFC,0x04,0x04,0x04,0x04,0x00,0x00}, // L
    {0x00,0x1F,0x18,0x06,0x18,0x1F,0x00,0x00,0x00,0xFC,0x00,0x00,0x00,0xFC,0x00,0x00}, // M
    {0x00,0x1F,0x18,0x06,0x01,0x1F,0x00,0x00,0x00,0xFC,0x00,0x00,0x00,0xFC,0x00,0x00}, // N
    {0x00,0x0F,0x10,0x10,0x10,0x0F,0x00,0x00,0x00,0xF0,0x08,0x04,0x08,0xF0,0x00,0x00}, // O
    {0x00,0x1F,0x11,0x11,0x11,0x0E,0x00,0x00,0x00,0xFC,0x00,0x00,0x00,0x00,0x00,0x00}, // P
    {0x00,0x0F,0x10,0x10,0x10,0x0F,0x00,0x00,0x00,0xF0,0x08,0x14,0x08,0xF4,0x00,0x00}, // Q
    {0x00,0x1F,0x11,0x11,0x11,0x0E,0x00,0x00,0x00,0xFC,0x00,0xC0,0x30,0x0C,0x00,0x00}, // R
    {0x00,0x0E,0x11,0x11,0x11,0x08,0x00,0x00,0x00,0x18,0x04,0x04,0x04,0xF8,0x00,0x00}, // S
    {0x00,0x10,0x10,0x1F,0x10,0x10,0x00,0x00,0x00,0x00,0x00,0xFC,0x00,0x00,0x00,0x00}, // T
    {0x00,0x1F,0x00,0x00,0x00,0x1F,0x00,0x00,0x00,0xF0,0x08,0x04,0x08,0xF0,0x00,0x00}, // U
    {0x00,0x1E,0x01,0x00,0x01,0x1E,0x00,0x00,0x00,0xE0,0x18,0x04,0x18,0xE0,0x00,0x00}, // V
    {0x00,0x1F,0x00,0x1F,0x00,0x1F,0x00,0x00,0x00,0xF0,0x18,0xF0,0x18,0xF0,0x00,0x00}, // W
    {0x00,0x10,0x0E,0x01,0x0E,0x10,0x00,0x00,0x00,0x0C,0x30,0xC0,0x30,0x0C,0x00,0x00}, // X
    {0x00,0x1C,0x02,0x01,0x02,0x1C,0x00,0x00,0x00,0x00,0x00,0xFC,0x00,0x00,0x00,0x00}, // Y
    {0x00,0x10,0x10,0x11,0x16,0x18,0x00,0x00,0x00,0x0C,0x34,0xC4,0x04,0x04,0x00,0x00}, // Z
};

unsigned int code ASCII_8x12_shijian[2][12] = {
    {0x02, 0x62, 0xa2, 0xbf, 0xa2, 0xe2, 0xaa, 0xaa, 0xa2, 0xe2, 0x02, 0x04},//0列
		{0x40, 0x5e, 0x82, 0xba, 0xaa, 0xaa, 0xba, 0xaa, 0xaa, 0xba, 0x82, 0x82},//1列
};//时间
unsigned int code ASCII_8x12_dianwei[2][12] = {
		{0x10, 0x1e, 0x1e, 0x7c, 0x44, 0x7c, 0x6a, 0x7a, 0x9a},//0列
		{0x28, 0x68, 0x7e, 0x42, 0xd2, 0x54, 0x54, 0x54, 0x7f},//1列
};//点位
unsigned int code ASCII_8x12_wendu[2][12] = {
    {0x00, 0x5e, 0x52, 0x9e, 0x92, 0x5e, 0x40, 0xfe, 0x6e, 0x6e, 0x7e, 0x00},   //0列
    {0x10, 0x7e, 0x54, 0x54, 0x7e, 0x54, 0x5c, 0x7c, 0x64, 0x94, 0x9c, 0x63}    //1列
};  //温度
unsigned int code ASCII_8x12_du[1][12] = {
    {0x00, 0x00, 0xcc, 0xe2, 0x20, 0x60, 0x60, 0x20, 0x22, 0x0c, 0x00, 0x00},   //0列
};  //°C
unsigned int code ASCII_8x12_dianya[2][12] = {
    {0x10, 0x7e, 0x7e, 0x52, 0x7e, 0x52, 0x7f, 0x53, 0x1f},   //0列
    {0x7f, 0x48, 0x48, 0x48, 0x7e, 0x4c, 0x4a, 0xca, 0xff}    //1列
};  //电压
unsigned int code ASCII_8x12_shangyi[5][12] = {
    {0x10, 0x10, 0x10, 0x10, 0x1c, 0x10, 0x10, 0x10, 0x10, 0x10, 0xfe, 0x00},   //0列
    {0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},   //1列
    {0x00, 0x0e, 0xe8, 0x5e, 0x52, 0x56, 0x56, 0x56, 0x7a, 0xcc, 0x02, 0x11},   //2列
    {0x00, 0xfe, 0x10, 0x10, 0x10, 0x14, 0x14, 0x12, 0x10, 0x10, 0x10, 0x10},   //下
		{0xfe, 0xfe, 0x30, 0x7c, 0x54, 0x54, 0x54, 0x54, 0x5c, 0x3c, 0x64, 0xe6},
};  //上一项、下,页
unsigned int code ASCII_8x12_shezhi[2][12] = {
    {0x00, 0x5c, 0x54, 0x14, 0xc2, 0x5e, 0x52, 0x44, 0x6c, 0x68, 0x14, 0x23},   //0列
    {0xfe, 0xfe, 0x10, 0xfe, 0x3c, 0x44, 0x7c, 0x7c, 0x44, 0x7c, 0xfe, 0x00}    //1列
};  //设置


unsigned int code ASCII_8x12_kh1[1][12] = {
    {0x02, 0x04, 0x04, 0x08, 0x08, 0x08, 0x04, 0x04, 0x02} //0列
       //1列
};  //括号1
unsigned int code ASCII_8x12_kh2[1][12] = {
      //0列
    {0x40, 0x60, 0x20, 0x20, 0x20, 0x20, 0x20, 0x60, 0x40}    //1列
};  //括号2

unsigned int code ASCII_8x12_maoh[1][12] = {
      //0列
   {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x40, 0x00, 0x00, 0x40, 0x00}   //1列
};  //冒号
unsigned int code ASCII_8x12_dengh[1][12] = {
      //0列
    {0x00, 0x00, 0x00, 0x00, 0xf0, 0x00, 0x00, 0xf0, 0x00, 0x00, 0x00, 0x00}    //1列
};  //等号

unsigned int code ASCII_8x12_celiangsj[4][12] = {
{0x7a, 0x7a, 0x6e, 0xbe, 0xbe, 0xfe, 0x7e, 0xfe, 0xfe, 0x5a, 0x7e, 0x66},
{0x7c, 0x7c, 0x7c, 0xff, 0xff, 0x7c, 0x7c, 0x7c, 0x7c, 0x7c, 0x7c, 0xfe},
{0xb4, 0xf4, 0x77, 0xfa, 0xfa, 0xbe, 0xf6, 0xf6, 0xd4, 0xe6, 0x6e, 0xfb},
{0x5e, 0x5e, 0x52, 0xfe, 0x54, 0x7f, 0xd4, 0xde, 0x5e, 0x7a, 0xee, 0xee}
};  //测量数据

unsigned int code ASCII_8x12_cgqzt[5][12] = {
    {0x28, 0x28, 0x7e, 0x48, 0x7f, 0xff, 0xde, 0x5e, 0x56, 0x4c, 0x4c, 0x44},
{0x06, 0x7f, 0x7f, 0x7e, 0x7e, 0x7e, 0xff, 0xbf, 0x8b, 0xba, 0xaf, 0xbd},
{0x7e, 0x7e, 0x5a, 0x7e, 0x14, 0xff, 0x3c, 0x6e, 0xc7, 0x7e, 0x5a, 0x7e},
{0x2a, 0x2a, 0xaa, 0x7f, 0x7f, 0x28, 0x6c, 0xec, 0xac, 0x36, 0x32, 0x33},
{0x10, 0xfe, 0xfe, 0x38, 0x3c, 0x76, 0x93, 0x3a, 0xaa, 0xa5, 0xbd, 0xbc}
};  //传感器状态

unsigned int code ASCII_8x12_cscx[4][12] = {
    {0x38, 0x2c, 0x7c, 0xfe, 0xfe, 0x6c, 0xfb, 0xbb, 0x3c, 0x6c, 0x38, 0xf0},   //0列
    {0xb4, 0xf4, 0x77, 0xfa, 0xfa, 0xbe, 0xf6, 0xf6, 0xd4, 0xe6, 0x6e, 0xfb},   //1列
    {0x10, 0xfe, 0xfe, 0x76, 0xd7, 0xff, 0x7c, 0x7c, 0x7c, 0x44, 0xff, 0xff},
{0x48, 0x58, 0x5e, 0x32, 0xfe, 0xde, 0x5e, 0x5e, 0x56, 0x7e, 0x66, 0x46}   //下
};  //参数查询

unsigned int code ASCII_8x12_fh[2][12] = {
 {0x46, 0x5e, 0x58, 0x1e, 0xde, 0xda, 0x5c, 0x5c, 0x7e, 0x72, 0xfe, 0xbf},
    // 列1（无全亮值，完全保留原始值）
    {0x7e, 0x42, 0x42, 0x7a, 0x6a, 0x6a, 0x6a, 0x7a, 0x7a, 0x7e, 0x42, 0x42}
}; //返回

unsigned int code ASCII_8x12_xg[2][12] = {
{0x48, 0x5e, 0x5e, 0xfc, 0xfe, 0xff, 0x7c, 0x74, 0x6e, 0x7c, 0x5c, 0x78},
{0x08, 0xe8, 0xef, 0x32, 0x3a, 0xfa, 0x8e, 0x8c, 0xac, 0xee, 0xda, 0x93}
}; //修改

unsigned int code ASCII_8x12_lsjl[4][12] = {
{0x7f, 0x7f, 0x48, 0x48, 0x7e, 0x7e, 0x5a, 0x52, 0x52, 0xf2, 0xa6, 0xe6},
{0x10, 0x10, 0x7e, 0x52, 0x52, 0x7e, 0x52, 0x50, 0x70, 0x38, 0x7c, 0xef},
{0x40, 0x5e, 0x5e, 0x02, 0xc2, 0xde, 0x52, 0x50, 0x50, 0x71, 0x7f, 0x4f},
{0x7c, 0x7c, 0x04, 0x7c, 0x04, 0xff, 0x52, 0x5e, 0x7c, 0x76, 0xf7, 0xb3}
};  //历史记录
unsigned int code ASCII_8x12_zzwh[4][12] = {
{0xa4, 0xff, 0x7f, 0x64, 0xfe, 0xbe, 0xff, 0xff, 0x3a, 0xfc, 0xb7, 0x33},
{0xfe, 0xBA, 0xBA, 0xfe, 0x7c, 0x7c, 0x44, 0x7c, 0x44, 0x7c, 0xff, 0xff},
{0x4c, 0x4c, 0x7f, 0xf4, 0xfe, 0x7e, 0xfe, 0xfe, 0x94, 0xff, 0xdf, 0x90},
{0x4c, 0x44, 0x5f, 0xf1, 0x51, 0x7f, 0x71, 0xd0, 0xd0, 0x50, 0xf0, 0xe0}
};  //装置维护

unsigned int code ASCII_8x12_khh[4][12] = {
{0x1e, 0x1e, 0x1e, 0x1c, 0x1c, 0x18, 0x18, 0x1c, 0x1c, 0x1e, 0x1e, 0x1e},
{0x78, 0x78, 0x78, 0x38, 0x38, 0x18, 0x18, 0x38, 0x38, 0x78, 0x78, 0x78},
{0x70, 0x70, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x70, 0x70},
{0xe0, 0xe0, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0xe0, 0xe0}

}; //中文方括号【】[]

unsigned int code ASCII_8x12_xsx[3][12] = {
{0x30, 0x20, 0xfe, 0x82, 0xba, 0xba, 0xaa, 0xaa, 0xba, 0xaa, 0x86, 0x86},
{0x10, 0x10, 0x10, 0x10, 0x1e, 0x1e, 0x10, 0x10, 0x10, 0x10, 0xff, 0xff},
{0xff, 0xff, 0x10, 0x10, 0x18, 0x1c, 0x16, 0x12, 0x12, 0x10, 0x10, 0x10}
};  //向上下


unsigned int code ASCII_8x12_bjsjjl[6][12] = {
{0x5e, 0x5e, 0x52, 0xf6, 0x52, 0x7e, 0x7a, 0xde, 0xd6, 0x56, 0xde, 0xdb},
{0xf4, 0xff, 0xff, 0xf6, 0xf6, 0xff, 0xff, 0xff, 0x7e, 0x7e, 0x7e, 0x7e},
{0x10, 0xff, 0xff, 0x7e, 0x7e, 0x7e, 0x7e, 0xff, 0xff, 0x7e, 0x30, 0x30},
{0x24, 0x34, 0x74, 0x5e, 0x54, 0xf4, 0xff, 0x7f, 0x44, 0x44, 0x44, 0x44},
{0x40, 0x5e, 0x5e, 0x02, 0xc2, 0xde, 0x52, 0x50, 0x50, 0x71, 0x7f, 0x4f},
{0x7c, 0x7c, 0x04, 0x7c, 0x04, 0xff, 0x52, 0x5e, 0x7c, 0x76, 0xf7, 0xb3}

};  //报警事件记录

unsigned int code ASCII_8x12_yjsjjl[6][12] = {
{0xff, 0xff, 0xec, 0x5e, 0xf6, 0xf6, 0x76, 0x56, 0x5e, 0x4e, 0xda, 0xd3},
{0xf4, 0xff, 0xff, 0xf6, 0xf6, 0xff, 0xff, 0xff, 0x7e, 0x7e, 0x7e, 0x7e},
{0x02, 0xe2, 0xe2, 0xbf, 0xa2, 0xe2, 0xaa, 0xaa, 0xaa, 0xe2, 0xa6, 0x06},
{0x5e, 0x5e, 0xc2, 0xba, 0xaa, 0xaa, 0xba, 0xaa, 0xaa, 0xba, 0x86, 0x86},
{0x40, 0x5e, 0x5e, 0x02, 0xc2, 0xde, 0x52, 0x50, 0x50, 0x71, 0x7f, 0x4f},
{0x7c, 0x7c, 0x04, 0x7c, 0x04, 0xff, 0x52, 0x5e, 0x7c, 0x76, 0xf7, 0xb3}
};  //预警时间记录

unsigned int code ASCII_8x12_cgq[9][12] = {
{0x28, 0x28, 0x7e, 0x48, 0x7f, 0xff, 0xde, 0x5e, 0x56, 0x4c, 0x4c, 0x44},
{0x06, 0x7f, 0x7f, 0x7e, 0x7e, 0x7e, 0xff, 0xbf, 0x8b, 0xba, 0xaf, 0xbd},
{0x7e, 0x7e, 0x5a, 0x7e, 0x14, 0xff, 0x3c, 0x6e, 0xc7, 0x7e, 0x5a, 0x7e},
{0x48, 0x48, 0x5f, 0xec, 0xec, 0xdd, 0xdf, 0x5e, 0x5e, 0x6e, 0x4a, 0x5b},
{0x40, 0x7e, 0x7e, 0xfc, 0xfc, 0x7c, 0x7c, 0x3c, 0x7c, 0xf8, 0x7c, 0xef},
{0x10, 0xff, 0xff, 0x7e, 0x7e, 0x7e, 0x7e, 0xff, 0xff, 0x7e, 0x30, 0x30},
{0x24, 0x34, 0x74, 0x5e, 0x54, 0xf4, 0xff, 0x7f, 0x44, 0x44, 0x44, 0x44},
{0x40, 0x5e, 0x5e, 0x02, 0xc2, 0xde, 0x52, 0x50, 0x50, 0x71, 0x7f, 0x4f},
{0x7c, 0x7c, 0x04, 0x7c, 0x04, 0xff, 0x52, 0x5e, 0x7c, 0x76, 0xf7, 0xb3}
};  //传感器恢复事件记录

unsigned int code ASCII_8x12_jr[2][12] = {
{0x4c, 0x4c, 0x5e, 0x0c, 0xcc, 0xff, 0x4c, 0x5c, 0x54, 0x74, 0xff, 0xbf},
{0x30, 0x10, 0x10, 0x18, 0x18, 0x18, 0x28, 0x2c, 0x24, 0x44, 0xc6, 0x83}
}; //进入

unsigned int code ASCII_8x12_lssjcx[6][12] = {
{0x7f, 0x7f, 0x48, 0x48, 0x7e, 0x7e, 0x5a, 0x52, 0x52, 0xf2, 0xa6, 0xe6},
{0x10, 0x10, 0x7e, 0x52, 0x52, 0x7e, 0x52, 0x50, 0x70, 0x38, 0x7c, 0xef},
{0xb4, 0xf4, 0x77, 0xfa, 0xfa, 0xbe, 0xf6, 0xf6, 0xd4, 0xe6, 0x6e, 0xfb},
{0x5e, 0x5e, 0x52, 0xfe, 0x54, 0x7f, 0xd4, 0xde, 0x5e, 0x7a, 0xee, 0xee},
{0x10, 0xfe, 0xfe, 0x76, 0xd7, 0xff, 0x7c, 0x7c, 0x7c, 0x44, 0xff, 0xff},
{0x48, 0x58, 0x5e, 0x32, 0xfe, 0xde, 0x5e, 0x5e, 0x56, 0x7e, 0x66, 0x46}

};  //历史数据查询

unsigned int code ASCII_8x12_zg[2][12] = {
{0x7c, 0x7c, 0x7c, 0x7c, 0xff, 0xff, 0x7e, 0x7e, 0x7c, 0xfc, 0xde, 0x9b},
{0x10, 0xff, 0xff, 0x3c, 0x24, 0x3c, 0xfe, 0xfe, 0xbe, 0xa6, 0xbe, 0xbe}
}; //最高

unsigned int code ASCII_8x12_jt[1][12] = {
{0x00, 0x00, 0x80, 0x40, 0x60, 0x20, 0x30, 0x20, 0x60, 0xc0, 0x80, 0x00}

}; //箭头

unsigned int code ASCII_8x12_xq[2][12] = {
{0x52, 0x56, 0x54, 0x3e, 0xc8, 0xde, 0x48, 0x7f, 0x7f, 0x68, 0x68, 0x48},
{0x48, 0x7e, 0x7e, 0xfe, 0xff, 0xff, 0xde, 0x5e, 0x5e, 0x5e, 0x56, 0x56}
}; //详情

unsigned int code ASCII_8x12_sc[4][12] = {
{0x7b, 0x7b, 0x4a, 0x4a, 0x4a, 0xff, 0x4a, 0x4a, 0x4a, 0x5a, 0xdf, 0x8d},
{0xc2, 0xc2, 0x4a, 0x4a, 0x4a, 0xea, 0x4a, 0x4a, 0x4a, 0x42, 0x4a, 0xce},
{0x78, 0x78, 0x59, 0x77, 0x75, 0x58, 0x4f, 0x6a, 0x7a, 0x4c, 0x49, 0x41},
{0x40, 0xe0, 0xb0, 0xfe, 0xf6, 0x40, 0xfc, 0x50, 0x58, 0x44, 0x44, 0xc0}
}; //删除
unsigned int code ASCII_8x12_qr[2][12] = {
{0x08, 0xee, 0xee, 0x5f, 0x7f, 0xed, 0xef, 0xed, 0x6f, 0x7d, 0x77, 0x53},
{0x48, 0x48, 0x48, 0x08, 0xc8, 0xc8, 0x4c, 0x4c, 0x7c, 0x76, 0x72, 0x23}
}; //确认
// 获取字符在字模数组中的索引
unsigned char GetCharIndex(unsigned char ch)
{
    if(ch == ' ') return 0;
    else if(ch >= '0' && ch <= '9') return (ch - '0' + 1);
    else if(ch >= 'A' && ch <= 'Z') return (ch - 'A' + 11);
    else return 0; // 如果是不支持的字符，返回空格的索引
}

// 翻转一个字节的位序
unsigned char ReverseByte(unsigned char byte)
{
    unsigned char result = 0;
    unsigned char i;
    
    for(i = 0; i < 8; i++)
    {
        result = (result << 1) | (byte & 0x01);
        byte >>= 1;
    }
    
    return result;
}
// lcd.c 中添加或修改
void LCD_DisplayNumber(unsigned char row, unsigned char col, 
                      unsigned long num, unsigned char digits) {
    unsigned char i;
    unsigned long divisor = 1;
    
    // 计算除数（如digits=4，则divisor=1000）
    for (i = 1; i < digits; i++) {
        divisor *= 10;
    }
    
    // 逐位显示数字
    for (i = 0; i < digits; i++) {
        unsigned char digit = (unsigned char)((num / divisor) % 10);
        LCD_DisplayChar(row, col + i * 8, digit + '0');  // 假设每个字符宽8像素
        divisor /= 10;
    }
}
// 新增：支持绝对行显示的ASCII字符函数
void LCD_DisplayChar_ASCII(unsigned char page, unsigned char offset, unsigned char column, unsigned char ch)
{
    unsigned char i, j, row_data;
    unsigned char (*font_array)[10];
    unsigned char ch_idx = GetCharIndex(ch);
    font_array = (unsigned char (*)[16])ASCII_8x16;
    
    LCD_SetAddress(page, column);
    // 从偏移行开始发送（当前页）
    for(i = offset; i < 8; i++)
    {
        row_data = 0;
        for(j = 0; j < 8; j++)
        {
            if(((unsigned char)font_array[ch_idx][j] & (1 << (7-i))))
            {
                row_data |= (1 << j);
            }
        }
        LCD_WriteData(row_data);
    }
    
    // 跨页补充发送
    LCD_SetAddress((unsigned char)(page + 1), column);
    for(i = 0; i < offset; i++)
    {
        row_data = 0;
        for(j = 0; j < 8; j++)
        {
            if(((unsigned char)font_array[ch_idx][j] & (1 << (7-i))))
            {
                row_data |= (1 << j);
            }
        }
        LCD_WriteData(row_data);
    }
};

// 显示一个8x16点阵的ASCII字符，8列宽（写入前做位反转）
void LCD_DisplayChar(unsigned char page, unsigned char column, unsigned char ch)
{
    unsigned char i;
    unsigned char ch_idx;

    ch_idx = GetCharIndex(ch);      // 获取字符在字模表中的索引

    // 上半部分（page，8行）
    LCD_SetAddress(page, column);
    for(i = 0; i < 8; i++)         // 8列宽
    {
        LCD_WriteData(ReverseByte(ASCII_8x16[ch_idx][i]));
    }

    // 下半部分（page+1，8行）
    LCD_SetAddress((unsigned char)(page + 1), column);
    for(i = 0; i < 8; i++)
    {
        LCD_WriteData(ReverseByte(ASCII_8x16[ch_idx][i + 8]));
    }
}

// 显示字符串
void LCD_DisplayString(unsigned char page, unsigned char column, unsigned char *str)
{
    while(*str)
    {
        if(column > 120) // 128-8=120，防止越界
            return;
        LCD_DisplayChar(page, column, *str);
        column += 8;  // 8列宽
        str++;
    }
}
// uart4.c 中的 LCD_HandleKey 函数
// 首先需要在文件顶部添加外部函数声明
//extern void led_toggle(unsigned char led_num);


/*显示汉字
LCD_DISPLAYCHAR_NEW(1*,2*,3*);
1*为起始页数，lcd分为8页，一页是8行，一个字模显示两页
2*为起始列数，lcd分为128列，一个字模占8列。
3*为你要显示的字模在数组中的下标。*/
// 函数参数修改：page -> row（绝对行号）
void LCD_DISPLAYCHAR_NEW(unsigned char page, unsigned char column, unsigned int ch, unsigned char type)
{
		unsigned char i, j;//如果想从任意行起始显示，可以添加偏移页地址 offset;
    unsigned char row_data;
    unsigned int (*font_array)[12];
    
    // 添加边界检查
    //if(row_data > LCD_MAX_ROW || column > LCD_MAX_COLUMN) return;
    
    // 新增：计算页地址和行偏移
    //page = row / 8;          // 目标行所在页
    //offset = row % 8;        // 页内偏移行数（0-7）
    
    // 根据type选择字模数组（原有逻辑保留）
    if(type == 1) { font_array = ASCII_8x12_wendu; }
    else if(type == 2) { font_array = ASCII_8x12_du; }
    else if(type == 3) { font_array = ASCII_8x12_dianya; }
    else if(type == 4) { font_array = ASCII_8x12_shangyi; }
    else if(type == 5) { font_array = ASCII_8x12_shezhi; }
		else if(type == 6)  {font_array = ASCII_8x12_kh1;}
		else if(type == 7)  {font_array = ASCII_8x12_kh2;}
		
		else if(type == 8)  {font_array = ASCII_8x12_celiangsj;}
	
		else if(type == 9)  {font_array = ASCII_8x12_cgqzt;}
		
		else if(type == 10)  {font_array = ASCII_8x12_cscx;}
		
		else if(type == 11)  {font_array = ASCII_8x12_fh;}
	
		else if(type == 12)  {font_array = ASCII_8x12_xg;}
		else if(type == 13)  {font_array = ASCII_8x12_lsjl;}
		else if(type == 14)  {font_array = ASCII_8x12_zzwh;}
		else if(type == 15)  {font_array = ASCII_8x12_maoh;}
		else if(type == 16)  {font_array = ASCII_8x12_dengh;}
		else if(type == 17)  {font_array = ASCII_8x12_khh;}
		else if(type == 18)  {font_array = ASCII_8x12_xsx;}
		else if(type == 19)  {font_array = ASCII_8x12_bjsjjl;}
		else if(type == 20)  {font_array = ASCII_8x12_yjsjjl;}
		else if(type == 21)  {font_array = ASCII_8x12_cgq;}
		else if(type == 22)  {font_array = ASCII_8x12_jr;}
		else if(type == 23)  {font_array = ASCII_8x12_lssjcx;}
		else if(type == 24)  {font_array = ASCII_8x12_zg;}
		else if(type == 25)  {font_array = ASCII_8x12_jt;}
		else if(type == 26)  {font_array = ASCII_8x12_xq;}
		else if(type == 27)  {font_array = ASCII_8x12_sc;}
		else if(type == 28)  {font_array = ASCII_8x12_qr;}
    else { font_array = ASCII_8x12_dianwei; }
    
    // 设置起始地址
    LCD_SetAddress(page, column);
    
    for(i = 0; i < 8; i++){         
        row_data = 0;
        for(j = 0; j < 8; j++)     // 8列
        {
            if(((unsigned char)font_array[ch][j] & (1 << (7-i))))
            {
                row_data |= (1 << j);
            }
        }
        LCD_WriteData(row_data);
    }
    
    // 下半部分（跨页处理）
    LCD_SetAddress((unsigned char)(page + 1), column);
    // 原有下半部分数据发送逻辑（后4列）
    for(i = 0; i < 8; i++)
    {
        row_data = 0;
        for(j = 0; j < 4; j++)
        {
            if(((unsigned char)font_array[ch][j + 8] & (1 << (7-i))))
            {
                row_data |= (1 << j);
            }
        }
        LCD_WriteData(row_data);
    }
}
